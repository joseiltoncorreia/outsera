name: ğŸš€ CI/CD Pipeline Completo - Testes Automatizados

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Executar testes diariamente Ã s 2h da manhÃ£
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  CYPRESS_VERSION: '13.6.0'
  APPIUM_VERSION: '2.19.0'

jobs:
  # Job 1: Testes de API
  api-tests:
    name: ğŸ§ª Testes de API
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Instalar dependÃªncias
      run: npm ci

    - name: ğŸ§ª Executar testes de API
      run: |
        echo "ğŸš€ Executando testes de API..."
        npm run test:api

    - name: ğŸ“Š Upload relatÃ³rios de API
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-reports
        path: |
          reports/api/
          coverage/
        retention-days: 30

  # Job 2: Testes E2E com Cypress
  e2e-tests:
    name: ğŸŒ Testes E2E (Cypress)
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Instalar dependÃªncias
      run: npm ci

    - name: ğŸ–¥ï¸ Setup Cypress
      uses: cypress-io/github-action@v6
      with:
        install-command: npm ci
        wait-on: 'http://localhost:3000'
        wait-on-timeout: 120

    - name: ğŸ§ª Executar testes E2E
      run: |
        echo "ğŸš€ Executando testes E2E com Cypress..."
        npm run test:e2e

    - name: ğŸ“Š Upload relatÃ³rios E2E
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-reports
        path: |
          cypress/reports/
          cypress/screenshots/
          cypress/videos/
        retention-days: 30

  # Job 3: Testes Mobile com Appium
  mobile-tests:
    name: ğŸ“± Testes Mobile (Appium)
    runs-on: ubuntu-latest
    env:
      ANDROID_HOME: /opt/android
      ANDROID_SDK_ROOT: /opt/android
      PATH: /opt/android/cmdline-tools/latest/bin:/opt/android/platform-tools:$PATH

    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Instalar dependÃªncias
      run: npm ci

    - name: ğŸ–¥ï¸ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ“± Download Android SDK
      run: |
        echo "ğŸ“± Baixando Android SDK..."
        sudo mkdir -p $ANDROID_HOME
        cd $ANDROID_HOME

        # Download Android SDK Command Line Tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
        unzip -q commandlinetools-linux-8512546_latest.zip
        rm commandlinetools-linux-8512546_latest.zip

        # Criar estrutura de diretÃ³rios correta
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/cmdline-tools/* cmdline-tools/latest/
        rmdir cmdline-tools/cmdline-tools

        # Configurar variÃ¡veis de ambiente
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools

        # Aceitar licenÃ§as
        yes | sdkmanager --licenses

        # Instalar SDK Platform e Build Tools
        sdkmanager "platforms;android-33" "build-tools;33.0.0" "platform-tools"

        echo "âœ… Android SDK configurado com sucesso!"

    - name: ğŸš€ Instalar e configurar Appium
      run: |
        echo "ğŸ“± Configurando Appium..."
        npm install -g appium@${{ env.APPIUM_VERSION }}
        appium driver install uiautomator2
        appium plugin install execute-driver

    - name: ğŸ“± Iniciar emulador Android
      run: |
        echo "ğŸ“± Iniciando emulador Android..."
        $ANDROID_HOME/emulator/emulator -list-avds
        $ANDROID_HOME/emulator/emulator -avd test_device -no-audio -no-window &
        adb wait-for-device
        adb devices

    - name: ğŸ§ª Executar testes Mobile
      run: |
        echo "ğŸš€ Executando testes Mobile..."
        npm run appium:test

    - name: ğŸ“Š Upload relatÃ³rios Mobile
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-test-reports
        path: |
          reports/mobile/
          screenshots/
        retention-days: 30

  # Job 4: Testes de SeguranÃ§a e Qualidade
  security-quality:
    name: ğŸ”’ SeguranÃ§a e Qualidade
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Instalar dependÃªncias
      run: npm ci

    - name: ğŸ” Auditoria de seguranÃ§a
      run: |
        echo "ğŸ”’ Executando auditoria de seguranÃ§a..."
        npm audit --audit-level=moderate

    - name: ğŸ“Š AnÃ¡lise de qualidade do cÃ³digo
      run: |
        echo "ğŸ“Š Analisando qualidade do cÃ³digo..."
        npm run lint
        npm run test:coverage

    - name: ğŸ“Š Upload relatÃ³rios de qualidade
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports
        path: |
          coverage/
          reports/quality/
        retention-days: 30

  # Job 5: Build e Deploy
  build-deploy:
    name: ğŸ—ï¸ Build e Deploy
    runs-on: ubuntu-latest
    needs: [api-tests, e2e-tests, mobile-tests, security-quality]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Instalar dependÃªncias
      run: npm ci

    - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o
      run: |
        echo "ğŸ—ï¸ Fazendo build da aplicaÃ§Ã£o..."
        npm run build

    - name: ğŸš€ Deploy para ambiente de produÃ§Ã£o
      run: |
        echo "ğŸš€ Fazendo deploy para produÃ§Ã£o..."
        # Aqui vocÃª pode adicionar comandos de deploy especÃ­ficos
        # como AWS, Azure, Heroku, etc.
        echo "âœ… Deploy concluÃ­do com sucesso!"

    - name: ğŸ“§ NotificaÃ§Ã£o de sucesso
      if: success()
      run: |
        echo "ğŸ“§ Enviando notificaÃ§Ã£o de sucesso..."
        # Aqui vocÃª pode integrar com Slack, Teams, email, etc.

  # Job 6: RelatÃ³rio Final
  final-report:
    name: ğŸ“Š RelatÃ³rio Final
    runs-on: ubuntu-latest
    needs: [api-tests, e2e-tests, mobile-tests, security-quality]
    if: always()

    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download de todos os relatÃ³rios
      uses: actions/download-artifact@v4
      with:
        path: all-reports/

    - name: ğŸ“Š Gerar relatÃ³rio consolidado
      run: |
        echo "ğŸ“Š Gerando relatÃ³rio consolidado..."
        npm run generate-consolidated-report

    - name: ğŸ“¤ Upload relatÃ³rio final
      uses: actions/upload-artifact@v4
      with:
        name: consolidated-test-report
        path: reports/consolidated/
        retention-days: 90

    - name: ğŸ“§ Enviar relatÃ³rio por email
      run: |
        echo "ğŸ“§ Enviando relatÃ³rio por email..."
        # Aqui vocÃª pode integrar com serviÃ§os de email
